Всем привет!

Это проект, посвященный управлению моторизированными шторами, и их интеграции в системы умного дома (напр. [Home Assistant](https://www.home-assistant.io/) или [OpenHab](https://www.openhab.org/)).  

Проект развивается в двух областях:
1. Программная часть (прошивка для контроллера на базе ESP8266 / ESP32)
2. Механическая часть (для превращения обычных рулонных штор в моторизованные). 

А теперь немного подробнее...
# Прошивка для ESP8266 / ESP32
Я стараюсь поддерживать работоспособность всех функций на обеих платформах.
Основные отличия:
- На ESP8266 доступно меньше пинов. Тут можно подключить только 2 шаговых двигателя к одному контроллеру (используя 8 пинов).
- ESP32 даёт возможность подключить 4 (или даже больше?) шаговых двигателя к одному контроллеру (используя 16 пинов).

## Основные возможности
- Поддержка доступных шаговых двигателей 28BYJ-48 (лучше использовать 12 вольтовые версии) 
- Управление неограниченным кол-вом шаговых двигателей (ограничение в 4 мотора стоит по-умолчанию для более удобного UI)
- Возможность задать скорость вращения (моторы на 12 вольт могут обеспечить бОльшую скорость)
- Возможность задать все основные настройки на этапе запуска системы через Captive WiFi Portal (используемые моторы, пины, скорость моторов, настройки MQTT и т.д.)
- Веб-интерфейс для выставления крайних точек и управления шторами (в том числе адаптирован под мобильные устройства)
- Возможность подключения внешнего механического выключателя для управления шторами.
- Поддержка MQTT (как для управления шторами, так и для настроек крайних положений - полная замена Web UI)
- Простая интеграция с популярными системами умного дома вроде Home Assistant и OpenHab (через MQTT)
- "Обновление по воздуху" (OTA updates). Не нужно снимать и разбирать контроллер для обновления прошивки.
- Сохранение положения каждой шторы в энергонезависимой ПЗУ
- Управлением всеми подключенными моторами в параллель (асинхронная работа с шаговыми двигателями)
- Watchdog (автоматический рестарт контроллера в случае зависания)
- Автоматическое поддержание подключения к MQTT серверу и реконнект
- Низкое энергопотребление в режиме простоя (обмотки двигателя не держатся под напряжением во время остановки)


## MQTT
Если не хотите использовать - не вводите адрес MQTT сервера при конфигурации в Captive Portal.
- При соединении контроллер отправляет сообщение в топик `ESP_Blinds/register` в JSON формате с двумя полями: `id` (chip id) и `ip` (используемый IP-адрес)
- Команды для управления шторами контроллер слушает в топике `ESP_Blinds/<chip_id>/in` (JSON)
- Обновления о позиции и своём состоянии контроллер отправляет в `ESP_Blinds/<chip_id>/out` (JSON)

## Пример интеграции с HomeAssistant 
Пример конфига для интеграции 2х штор с Home Assistant (замените "2955439908" вашим Chip id - его можно подглядеть в сообщении о регистрации):
```
cover:
  - platform: mqtt
    name: "Штора 1"
    device_class: "blind"
    command_topic: "ESP_Blinds/2955439908/in"
    set_position_topic: "ESP_Blinds/2955439908/in"
    set_position_template: '{"num": 1, "action": "auto", "value": {{ 100 - position }} }'
    position_topic: "ESP_Blinds/2955439908/out"
    position_template: '{{ value_json.position1 }}'
    payload_open: '{"num": 1, "action": "auto", "value": 0}'
    payload_close: '{"num": 1, "action": "auto", "value": 100}'
    payload_stop: '{"num": 1, "action": "stop", "value": 0}'
    position_open: 0
    position_closed: 100
    optimistic: false

  - platform: mqtt
    name: "Штора 2"
    device_class: "blind"
    command_topic: "ESP_Blinds/2955439908/in"
    set_position_topic: "ESP_Blinds/2955439908/in"
    set_position_template: '{"num": 2, "action": "auto", "value": {{ 100 - position }} }'
    position_topic: "ESP_Blinds/2955439908/out"
    position_template: '{{ value_json.position2 }}'
    payload_open: '{"num": 2, "action": "auto", "value": 0}'
    payload_close: '{"num": 2, "action": "auto", "value": 100}'
    payload_stop: '{"num": 2, "action": "stop", "value": 0}'
    position_open: 0
    position_closed: 100
    optimistic: false
```

Аналогично добавляются все остальные шторы.

# Механическая часть

Наиболее распространённый вариант использует двигатели 28BYJ-48, но фактически вы можете использовать любые шаговые двигатели с управлением по 4м контактам (двигатели с двумя обмотками).
28BYJ-48 чаще всего используют вместе с драйвером ULN2003 (лучше на 12 вольт, он даёт бОльший крутящий момент).

Я разработал 2 варианта переделки рулонных штор из Леруа Мерлен в моторизованные:
1. для старого образца крепления. Похоже их почти уже не продают.
2. для нового образца (скоро опубликую). Крепёжные отверстия совпадают с оригинальными деталями, поэтому шторы могут быть легко превращены в моторизованные и обратно.

Модели для 3д печати доступны каталоге `3d_parts` или напрямую на [Thingiverse](https://www.thingiverse.com/thing:4093205/)

# История проекта
Этот проект изначально был основан на работе товарища @nidayand - как форк от его [репозитория](https://github.com/nidayand/motor-on-roller-blind-ws).

К сожалению проект поддерживал только ESP8266 и управление 1 двигателем, плюс давно не обновлялся. Я добавил поддержку Platformio (для более удобной разработки), нескольких моторов, а позже и ESP32 (чтобы можно было подключить более 2х моторов к одному контроллеру). Это было опубликовало под версией 1.4.x.

Вскоре захотелось более удобного управления двигателями, простой конфигурации контроллера без правки прошивки, но изначальный код был малопригоден для поддержания, хотя и работал.
В результате произошёл большой рефакторинг прошивки - были выделены новые классы, зоны ответственности. 

Фактически стало понятно, что от старого проекта почти ничего не осталось (непереработанным остался только лишь Web UI). Этот проект был выделен в свою отдельную ветку и теперь развивается самостоятельно.